import{r as L,w as ee,b as U,j as H,o as m,c as N,a as u,R as g,S as ue,u as w,L as O,b2 as fe,b1 as pe,aK as me,H as he,K as i,U as S,O as d,Q as x,P as E,ab as K,ac as ge,n as we,G as X,W as ae,a7 as ye,ah as ve}from"./@vue-7a379fd5.js";import{E as be,a as $e,b as q,c as Fe,d as te,e as ie,f as Ie,g as re,h as Le,i as Ee,j as Te,k as ke,l as de,v as ce}from"./element-plus-9fcb87aa.js";import{p as P,H as j,o as ze,a as Ne,D as Me}from"./@lark-base-open-c2afdc6b.js";import{l as R}from"./lodash-8cd12701.js";import{t as Se,g as xe,i as se,h as De,q as Ae,w as Ce,r as Ve}from"./@element-plus-4a63cc69.js";import{F as Pe}from"./file-saver-f4091ce1.js";import{J as Ue}from"./jszip-f4b7e1d9.js";import{a as Be}from"./axios-23217866.js";import{c as Oe}from"./vue-i18n-bd3d600e.js";import{t as Q}from"./await-to-js-94a677b8.js";import{d as Re}from"./vuedraggable-0c64fc68.js";import{u as Ke}from"./@vueuse-af466026.js";import"./lodash-es-1097e500.js";import"./async-validator-604317c1.js";import"./@ctrl-aa1b1e70.js";import"./@popperjs-535f1f87.js";import"./normalize-wheel-es-5e9aec41.js";import"./dayjs-81338e0f.js";import"./@intlify-f1f31afd.js";import"./vue-9ffcc18e.js";import"./sortablejs-9437a160.js";const je=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const e of o)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&l(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const e={};return o.integrity&&(e.integrity=o.integrity),o.referrerpolicy&&(e.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?e.credentials="include":o.crossorigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function l(o){if(o.ep)return;o.ep=!0;const e=s(o);fetch(o.href,e)}};je();const Z=(n,t)=>{const s=n.__vccOpts||n;for(const[l,o]of t)s[l]=o;return s},oe=n=>(fe("data-v-2f309e18"),n=n(),pe(),n),He={version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",x:"0px",y:"0px",style:{display:"none"}},qe=me('<symbol id="wave" data-v-2f309e18><path d="M420,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C514,6.5,518,4.7,528.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H420z" data-v-2f309e18></path><path d="M420,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C326,6.5,322,4.7,311.5,2.7C304.3,1.4,293.6-0.1,280,0c0,0,0,0,0,0v20H420z" data-v-2f309e18></path><path d="M140,20c21.5-0.4,38.8-2.5,51.1-4.5c13.4-2.2,26.5-5.2,27.3-5.4C234,6.5,238,4.7,248.5,2.7c7.1-1.3,17.9-2.8,31.5-2.7c0,0,0,0,0,0v20H140z" data-v-2f309e18></path><path d="M140,20c-21.5-0.4-38.8-2.5-51.1-4.5c-13.4-2.2-26.5-5.2-27.3-5.4C46,6.5,42,4.7,31.5,2.7C24.3,1.4,13.6-0.1,0,0c0,0,0,0,0,0l0,20H140z" data-v-2f309e18></path></symbol>',1),Ze=[qe],Ge={class:"box"},Xe={class:"percent"},Qe={class:"percentNum",id:"count"},Ye=oe(()=>u("div",{class:"percentB"},"%",-1)),Je=oe(()=>u("svg",{viewBox:"0 0 560 20",class:"water_wave water_wave_back"},[u("use",{"xlink:href":"#wave"})],-1)),We=oe(()=>u("svg",{viewBox:"0 0 560 20",class:"water_wave water_wave_front"},[u("use",{"xlink:href":"#wave"})],-1)),et=[Je,We],tt={__name:"ProgressCircle",props:{percent:{type:Number,default:0}},setup(n){const t=n,s=L(0);ee(()=>t.percent,o=>{s.value=o,s.value>=100?s.value=100:s.value});const l=U(()=>({transform:`translate(0, ${100-s.value}%)`}));return H(()=>{s.value=t.percent}),(o,e)=>(m(),N(O,null,[(m(),N("svg",He,Ze)),u("div",Ge,[u("div",Xe,[u("div",Qe,g(s.value),1),Ye]),u("div",{id:"water",class:"water",style:ue(w(l))},et,4)])],64))}},ot=Z(tt,[["__scopeId","data-v-2f309e18"]]),st=(n,t)=>{let s;return(...l)=>{clearTimeout(s),s=setTimeout(()=>{n(...l)},t)}},le=n=>n>=1073741824?(n/1073741824).toFixed(2)+"G":n>=1048576?(n/1048576).toFixed(2)+"M":n>=1024?(n/1024).toFixed(2)+"K":n.toFixed(2)+"B",Y=n=>n.replace(/[\n\t\r]/g,"").replace(/\//g,"-"),lt=n=>{var t,s;return n?Array.isArray(n)&&n.length?((t=n[0])==null?void 0:t.text)||((s=n[0])==null?void 0:s.name):typeof n=="object"?n.text||n.name:n:""},nt=(n,t,s="")=>{const l=n.split(".").pop();return t?`${t}.${l}`:`${s}.${l}`},at=(n,t)=>{const s=[];for(n.sort((l,o)=>o.size-l.size);n.length>0;){const l=[];let o=0;for(let e=0;e<n.length;e++)o+n[e].size<=t&&(l.push(n[e]),o+=n[e].size,n.splice(e,1),e--);s.push(l)}return s},C={FIELD_NAME:"FIELD_NAME",HEADER_NAME:"HEADER_NAME",FILE_NAME:"FILE_NAME",CUSTOM_TEXT:"CUSTOM_TEXT"},it={[C.FIELD_NAME]:"primary",[C.HEADER_NAME]:"warning",[C.FILE_NAME]:"success",[C.CUSTOM_TEXT]:"info"},rt="Usage Instructions",dt="It is recommended to use Chrome browser to download, as downloading from other browsers may encounter some abnormal issues",ct="Call the browser's native download function. If the browser prompts to download multiple files, please select 'Allow'",_t="To download attachments, ensure that you have permission to do so",ut="When downloading files as a zip, if the attachments are too large, they will be downloaded separately to prevent browser crashes",ft="The download path is the browser's default download path. During download, the original file name of the attachment will be used. If there are duplicate names, the browser will automatically add a suffix for differentiation",pt="When adding data tables, views, or fields to multidimensional tables, please rerun this tool",mt="The Zip packaging function uses the JSZip plugin. The experience with large data responses is slow. Currently, it is only used for code communication and learning. For large files, please use the individual download mode.",ht="Refresh Form",gt="Data Table Column",wt="View Column",yt="Attachment Fields",vt="File Naming Method",bt="File Name Field",$t="Download Method",Ft="First Directory",It="Second Directory",Lt="Download",Et="File Download",Tt="Download Progress",kt="Download Details",zt="Complete",Nt="Select Data Table",Mt="Select View",St="Select Attachment Fields",xt="Select File Naming Method",Dt="Select File Name Field",At="Select Download Method",Ct="Folder Classification",Vt="You can download by folder classification based on the selected field",Pt="Original File Name",Ut="Select from Table Fields",Bt="Download Individual Files",Ot="Zip Download",Rt="Yes",Kt="No",jt="Select First Directory",Ht="Select Second Directory",qt="Fetching file information...",Zt="There are no files to download currently. Please confirm.",Gt="There are fileQty files pending download.",Xt="Calculating the number of files to download... fileQty files. If it's slow, please refresh the page and try again.",Qt="Preparing to download files",Yt="Total file size",Jt="File packing in progress: percentage% completed.",Wt="Failed to download file_name, error message: error_message",eo="Downloading file index, current progress percentage%",to="The current file size is about to exceed max_size GB. To avoid plugin crashes, we will first download it to your local storage before proceeding with subsequent downloads...",oo="unclassified",so={usage_instructions:rt,notice_1:dt,notice_2:ct,notice_3:_t,notice_4:ut,notice_5:ft,notice_6:pt,notice_7:mt,refresh_form:ht,data_table_column:gt,view_column:wt,attachment_fields:yt,file_naming_method:vt,file_name_field:bt,download_method:$t,first_directory:Ft,second_directory:It,download:Lt,file_download:Et,download_progress:Tt,download_details:kt,complete:zt,select_data_table:Nt,select_view:Mt,select_attachment_fields:St,select_file_naming_method:xt,select_file_name_field:Dt,select_download_method:At,folder_classification:Ct,folder_classification_hint:Vt,original_file_name:Pt,select_from_table_fields:Ut,download_individual_files:Bt,zip_download:Ot,yes:Rt,no:Kt,select_first_directory:jt,select_second_directory:Ht,fetching_file_info_message:qt,no_files_to_download_message:Zt,files_pending_download_message:Gt,calculating_files_message:Xt,preparing_to_download_files_message:Qt,total_file_size_message:Yt,file_packing_progress_message:Jt,file_download_failed_message:Wt,downloading_file_progress:eo,file_size_warning_message:to,uncategorized:oo,undefined:"undefined"},lo="\u4F7F\u7528\u987B\u77E5",no="\u63A8\u8350\u4F7F\u7528chrome\u6D4F\u89C8\u5668\u4E0B\u8F7D\uFF0C\u5176\u4ED6\u6D4F\u89C8\u5668\u4E0B\u8F7D\u4F1A\u51FA\u73B0\u4E00\u4E9B\u5F02\u5E38\u95EE\u9898",ao="\u8C03\u7528\u6D4F\u89C8\u5668\u539F\u751F\u4E0B\u8F7D\u529F\u80FD\uFF0C\u82E5\u6D4F\u89C8\u5668\u63D0\u793A\u4E0B\u8F7D\u591A\u4E2A\u6587\u4EF6\u65F6\uFF0C\u8BF7\u9009\u62E9\u300C\u5141\u8BB8\u300D",io="\u8981\u6709\u9644\u4EF6\u4E0B\u8F7D\u6743\u9650\uFF0C\u4F7F\u7528\u65F6\u8BF7\u786E\u4FDD\u62E5\u6709\u6743\u9650",ro="\u6587\u4EF6\u4E0B\u8F7D\u65B9\u5F0F\u4E3Azip\u65F6\uFF0C\u82E5\u9644\u4EF6\u8FC7\u5927\uFF0C\u5219\u4F1A\u9ED8\u8BA4\u5206\u5F00\u4E0B\u8F7D\uFF0C\u907F\u514D\u6D4F\u89C8\u5668\u5D29\u6E83",co="\u4E0B\u8F7D\u8DEF\u5F84\u4E3A\u6D4F\u89C8\u5668\u9ED8\u8BA4\u4E0B\u8F7D\u8DEF\u5F84\uFF1B\u4E0B\u8F7D\u65F6\uFF0C\u4F7F\u7528\u9644\u4EF6\u7684\u539F\u59CB\u6587\u4EF6\u540D\uFF0C\u82E5\u51FA\u73B0\u91CD\u540D\uFF0C\u6D4F\u89C8\u5668\u5C06\u81EA\u52A8\u6DFB\u52A0\u540E\u7F00\u505A\u533A\u5206",_o="\u591A\u7EF4\u8868\u683C\u65B0\u589E\u6570\u636E\u8868\u3001\u89C6\u56FE\u6216\u5B57\u6BB5\u65F6\uFF0C\u8BF7\u91CD\u65B0\u8FD0\u884C\u672C\u5DE5\u5177",uo="Zip\u6253\u5305\u529F\u80FD\u4F7F\u7528\u4E86JSZip\u63D2\u4EF6\uFF0C\u5927\u6570\u636E\u54CD\u5E94\u4F53\u9A8C\u8F83\u6162\uFF0C\u5F53\u524D\u4EC5\u4F5C\u4EE3\u7801\u4EA4\u6D41\u5B66\u4E60\u7528\u3002\u5927\u6587\u4EF6\u65F6\uFF0C\u8BF7\u4F7F\u7528\u9010\u4E2A\u4E0B\u8F7D\u6A21\u5F0F\u3002",fo="\u5237\u65B0\u8868\u5355",po="\u6570\u636E\u8868\u5217",mo="\u89C6\u56FE\u5217",ho="\u9644\u4EF6\u5B57\u6BB5",go="\u6587\u4EF6\u547D\u540D\u65B9\u5F0F",wo="\u5B57\u6BB5\u5217",yo="\u4E0B\u8F7D\u65B9\u5F0F",vo="\u4E00\u7EA7\u76EE\u5F55",bo="\u4E8C\u7EA7\u76EE\u5F55",$o="\u4E0B\u8F7D",Fo="\u6587\u4EF6\u4E0B\u8F7D",Io="\u4E0B\u8F7D\u603B\u8FDB\u5EA6",Lo="\u4E0B\u8F7D\u8BE6\u60C5",Eo="\u5B8C\u6210",To="\u8BF7\u9009\u62E9\u6570\u636E\u8868",ko="\u8BF7\u9009\u62E9\u6570\u636E\u8868",zo="\u8BF7\u9009\u62E9\u9644\u4EF6\u5B57\u6BB5",No="\u8BF7\u9009\u62E9\u9644\u4EF6\u5B57\u6BB5",Mo="\u8BF7\u9009\u62E9\u6587\u4EF6\u547D\u540D\u5B57\u6BB5",So="\u8BF7\u9009\u62E9\u4E0B\u8F7D\u65B9\u5F0F",xo="\u6587\u4EF6\u5939\u5206\u7C7B",Do="\u53EF\u6839\u636E\u6240\u9009\u5B57\u6BB5\u8FDB\u884C\u4E00\u7EA7\u3001\u4E8C\u7EA7\u6587\u4EF6\u5939\u5206\u7C7B\u4E0B\u8F7D",Ao="\u539F\u6587\u4EF6\u540D\u79F0",Co="\u4ECE\u8868\u5B57\u6BB5\u9009\u62E9",Vo="\u9010\u4E2A\u6587\u4EF6\u4E0B\u8F7D",Po="zip\u6253\u5305\u4E0B\u8F7D",Uo="\u662F",Bo="\u5426",Oo="\u8BF7\u9009\u62E9\u4E00\u7EA7\u76EE\u5F55",Ro="\u8BF7\u9009\u62E9\u4E8C\u7EA7\u76EE\u5F55",Ko="\u65E0\u7C7B\u522B",jo="\u6587\u4EF6\u4E0B\u8F7D\u5931\u8D25",Ho="\u9519\u8BEF\u4FE1\u606F",qo="\u6B63\u5728\u4E0B\u8F7D\u7B2C index \u4E2A\u6587\u4EF6\uFF0C\u5F53\u524D\u6587\u4EF6\u4E0B\u8F7D\u8FDB\u5EA6percentage%",Zo="file_name \u6587\u4EF6\u4E0B\u8F7D\u5931\u8D25\uFF0C\u9519\u8BEF\u4FE1\u606F\uFF1Aerror_message",Go="\u6253\u5305\u6587\u4EF6\u751F\u6210\u4E2D\uFF1Apercentage%\u5DF2\u5B8C\u6210\u3002",Xo="\u5F53\u524D\u6587\u4EF6\u5927\u5C0F\u5373\u5C06\u8D85\u8FC7 max_size GB\uFF0C\u907F\u514D\u63D2\u4EF6\u5D29\u6E83\uFF0C\u51C6\u5907\u5148\u4E0B\u8F7D\u5230\u60A8\u672C\u5730\uFF0C\u518D\u8FDB\u884C\u540E\u7EED\u4E0B\u8F7D...",Qo="\u8BA1\u7B97\u5F85\u4E0B\u8F7D\u6587\u4EF6\u6570\u91CF\u2026\u2026 fileQty \u4E2A\u3002\u82E5\u8F83\u6162\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u540E\u91CD\u65B0\u5C1D\u8BD5\u3002",Yo="\u5171\u8BA1\u6709 fileQty \u4E2A\u6587\u4EF6\u5F85\u4E0B\u8F7D\u3002",Jo="\u5F53\u524D\u65E0\u6587\u4EF6\u9700\u8981\u4E0B\u8F7D\uFF0C\u8BF7\u786E\u8BA4\u3002",Wo="\u6B63\u5728\u83B7\u53D6\u6587\u4EF6\u4FE1\u606F...",es="\u5F53\u524D\u6587\u4EF6\u603B\u5927\u5C0F",ts="\u51C6\u5907\u4E0B\u8F7D\u6587\u4EF6",os={usage_instructions:lo,notice_1:no,notice_2:ao,notice_3:io,notice_4:ro,notice_5:co,notice_6:_o,notice_7:uo,refresh_form:fo,data_table_column:po,view_column:mo,attachment_fields:ho,file_naming_method:go,file_name_field:wo,download_method:yo,first_directory:vo,second_directory:bo,download:$o,file_download:Fo,download_progress:Io,download_details:Lo,complete:Eo,select_data_table:To,select_view:ko,select_attachment_fields:zo,select_file_naming_method:No,select_file_name_field:Mo,select_download_method:So,folder_classification:xo,folder_classification_hint:Do,original_file_name:Ao,select_from_table_fields:Co,download_individual_files:Vo,zip_download:Po,yes:Uo,no:Bo,select_first_directory:Oo,select_second_directory:Ro,uncategorized:Ko,undefined:"\u672A\u5B9A\u4E49",file_download_failed:jo,error_message:Ho,downloading_file_progress:qo,file_download_failed_message:Zo,file_packing_progress_message:Go,file_size_warning_message:Xo,calculating_files_message:Qo,files_pending_download_message:Yo,no_files_to_download_message:Jo,fetching_file_info_message:Wo,total_file_size_message:es,preparing_to_download_files_message:ts},G=Oe({locale:"zh",allowComposition:!0,messages:{en:so,zh:os}});P.bridge.getLanguage().then(n=>{G.global.locale=n});class ss{constructor(t=5){this.parallelCount=t,this.tasks=[],this.runningCount=0,this.resolveFinished=null,this.rejectFinished=null,this.errors=[]}add(t){return new Promise((s,l)=>{this.tasks.push({task:t,resolve:s,reject:l}),this._run()})}setTasks(t){t.forEach(s=>this.add(s))}finished(){return new Promise((t,s)=>{this.tasks.length===0&&this.runningCount===0?this.errors.length>0?s(this.errors):t():(this.resolveFinished=t,this.rejectFinished=s)})}_run(){for(;this.runningCount<this.parallelCount&&this.tasks.length>0;){const{task:t,resolve:s,reject:l}=this.tasks.shift();this.runningCount++,t().then(s).catch(o=>{this.errors.push(o),s()}).finally(()=>{this.runningCount--,this._checkFinished(),this._run()})}}_checkFinished(){this.tasks.length===0&&this.runningCount===0&&(this.errors.length>0?this.rejectFinished&&this.rejectFinished(this.errors):this.resolveFinished&&this.resolveFinished())}}const J=G.global.t,ls=1,ns=ls*1024*1024*1024,ne=async({type:n,name:t,id:s},l,o)=>{var e;return n===C.FILE_NAME?l.name.split(".")[0]:n===C.CUSTOM_TEXT?t:n===C.HEADER_NAME?(e=o.attachmentList.find(a=>a.id===l.fieldId))==null?void 0:e.name:await o.oTable.getCellString(s,l.recordId)};class as{constructor(t){Object.keys(t).map(s=>{this[s]=R.exports.cloneDeep(t[s])}),this.oTable=null,this.currentTotalSize=0,this.nameSpace=new Set,this.zip=null,this.cellList=[]}async loopGetRecordIdList(t,s,l){const o={pageSize:200};l&&(o.pageToken=l);const[e,a]=await Q(t.getVisibleRecordIdListByPage(o));if(e)console.log(e);else{const{hasMore:r,recordIds:y,pageToken:p}=a;s.push(...y),r&&p&&await this.loopGetRecordIdList(t,s,p)}return s}async getCellsList(){const t=await this.oTable.getViewById(this.viewId),s=await this.loopGetRecordIdList(t,[]);let l=[];for(const o of this.attachmentFileds)for(const e of s){let a=await this.oTable.getCellValue(o,e);a?(a=a.map(r=>({...r,name:Y(r.name),recordId:e,fieldId:o,path:"",fileUrl:""})),l.push(...a),this.emit("preding",a)):this.emit("preding")}return l=l.map((o,e)=>({...o,order:e+1})),l}on(t,s){return this[t+"Listeners"]||(this[t+"Listeners"]=[]),this[t+"Listeners"].push(s),this}emit(t,s){var l;(l=this[t+"Listeners"])==null||l.forEach(o=>{o(s)})}async setFileNames(){const t=this.fileNamekList,s=async(a,r)=>(await Promise.all(r.map(p=>ne(p,a,this)))).filter(p=>p).join(""),l=(a,r)=>{if(r!==a.name){const y=nt(a.name,r,J("undefined"));a.name=Y(y)}},o=this.cellList.map(a=>s(a,t));(await Promise.all(o)).forEach((a,r)=>{l(this.cellList[r],a)})}async setFolderPath(){if(this.downloadType!==1||!this.downloadTypeByFolders)return;const t=async(l,o)=>{const e=await Promise.all(l.map(r=>ne(r,o,this)));console.log(this.attachmentList,o);const a=e.filter(r=>r).join("");return Y(lt(a))||J("uncategorized")},s=async(l,o,e)=>{let a="";o&&o.length&&(a+=`${await t(o,l)}/`),e&&e.length&&(a+=`${await t(e,l)}/`),l.path=a};await Promise.all(this.cellList.map(l=>s(l,this.firstFolderKeys,this.secondFolderKeys)))}getUniqueFileName(t,s){const l=t.substring(t.lastIndexOf(".")),o=t.substring(0,t.lastIndexOf("."));let e=1;for(;this.nameSpace.has(s+t);)t=`${o}_${e}${l}`,e++;return this.nameSpace.add(s+t),t}async zipDownLoad(){const t=at(this.cellList,ns);for(const s of t){this.zip=new Ue,this.currentTotalSize=0;const l=new ss(5),o=s.map(r=>async()=>await this.processFile(r));l.setTasks(o),await l.finished().catch(r=>{});const[e,a]=await Q(this.zip.generateAsync({type:"blob"},r=>{const y=r.percent.toFixed(2);this.emit("zip_progress",y)}));e?this.emit("max_size_warning"):(Pe.exports.saveAs(a,`${this.zipName}.zip`),this.zip=null)}}async getAttachmentUrl(t){const{token:s,fieldId:l,recordId:o,path:e,name:a}=t;t.name=this.getUniqueFileName(a,e),t.fileUrl=await this.oTable.getAttachmentUrl(s,l,o)}async processFile(t){await this.getAttachmentUrl(t);const s=await this.downloadFile(t);s&&this.zip.file(`${t.path}${t.name}`,s)}async sigleDownLoad(t){const s=t?[t]:this.cellList,l=async o=>{const e=await this.downloadFile(o);if(e){const a=URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",a),r.setAttribute("download",o.name),r.click(),URL.revokeObjectURL(a)}};for(let o=0;o<s.length;o++){const e=s[o];await this.getAttachmentUrl(e),await l(e)}}async downloadFile(t){const{fileUrl:s,name:l,order:o,size:e}=t;let a=!1;this.emit("progress",{index:o,name:l,size:e,percentage:0});const[r,y]=await Q(Be({method:"get",responseType:"blob",url:s,onDownloadProgress:p=>{if(p.lengthComputable&&!a){const T=Math.round(p.loaded*100/p.total);this.emit("progress",{index:o,percentage:T})}}}));return a||(this.emit("progress",{index:o,percentage:100}),a=!0),r?(this.emit("error",{message:r.message,index:o}),null):y.data}async startDownload(){if(this.oTable=await P.base.getTableById(this.tableId),this.cellList=await this.getCellsList(),await this.setFileNames(),await this.setFolderPath(),!this.cellList.length)return this.emit("info",J("no_files_to_download_message")),this.emit("finshed"),"";this.downloadType===2?await this.sigleDownLoad():await this.zipDownLoad(),this.emit("finshed")}}const is={class:"dialog-process"},rs={class:"dialog-circle"},ds={class:"prompt"},cs={key:0,style:{color:"var(--el-color-warning)","line-height":"1.5"}},_s={key:1,style:{color:"red"}},us=x("\u4E0B\u8F7D\u4E2D"),fs=x("\u4E0B\u8F7D\u6210\u529F"),ps=x("\u4E0B\u8F7D\u5931\u8D25"),ms={__name:"DownModel",props:{attachmentList:{type:Array,default:()=>[]},zipName:{type:String,default:""},formData:{type:Object,default:()=>{}}},emits:["finsh"],setup(n,{emit:t}){const s=n,l=G.global.t,o=1073741824*1,e=L(new Set),a=L(!1),r=L(0),y=L(0),p=L([]),T=L(""),k=L(0),A=L(""),B=U(()=>e.value.size),c=U(()=>(B.value/y.value*100).toFixed(2)-0||0),b=st(()=>{const I={loading:1,error:2,default:3};p.value.length>20&&(p.value=p.value.filter(F=>F.type!=="success")),p.value.sort((F,v)=>(I[F.type]||I.default)-(I[v.type]||I.default))},200),{formData:$,zipName:h,attachmentList:M}=he(s);return H(async()=>{const I=new as({...$.value,zipName:h.value,attachmentList:[...M.value]});I.on("preding",F=>{k.value+=1,F&&(y.value+=F.length,F.forEach(v=>{r.value+=v.size}))}),I.on("error",F=>{const{index:v,message:D}=F,V=p.value.findIndex(z=>z.index===v);V!==-1&&(p.value[V].type="error",p.value[V].percentage=D,b())}),I.on("max_size_warning",F=>{a.value=!0}),I.on("progress",F=>{const{index:v,percentage:D,name:V,size:z}=F;if(e.value.has(v))return;const f=p.value.findIndex(_e=>_e.index===v);f===-1?p.value.unshift({index:v,percentage:D,name:V,size:z,type:"loading"}):(p.value[f].percentage=D,D>=100?(p.value[f].type="success",e.value.add(v),b()):p.value[f].type="loading")}),I.on("finshed",F=>{t("finsh")}),I.on("zip_progress",F=>{T.value="";const v=l("file_packing_progress_message").replace("percentage",F);A.value=v}),await I.startDownload()}),(I,F)=>{const v=be,D=q,V=$e;return m(),N("div",is,[u("h4",null,g(w(l)("download_progress")),1),u("div",rs,[i(ot,{percent:w(c)},null,8,["percent"])]),u("h4",null,g(w(l)("download_details")),1),u("div",ds,[r.value>o?(m(),N("p",cs,"\u5F53\u524D\u4E0B\u8F7D\u9644\u4EF6\u8FC7\u5927\uFF0C\u63A8\u8350\u8FDB\u884C\u89C6\u56FE\u7B5B\u9009\uFF0C\u5982\u60A8\u4E0B\u8F7D\u5954\u6E83\u6216\u8005\u65E0\u53CD\u5E94\uFF0C\u8BF7\u4F7F\u7528chrome\u6D4F\u89C8\u5668\u4E0B\u8F7D")):S("",!0),u("p",null,"\u5171\u8BA1\u6709 "+g(y.value)+" \u4E2A\u6587\u4EF6\u5F85\u4E0B\u8F7D\u3002",1),u("p",null,"\u5F53\u524D\u6587\u4EF6\u603B\u5927\u5C0F"+g(w(le)(r.value)),1),u("p",null,"\u5DF2\u4E0B\u8F7D\u6587\u4EF6\u6570\u91CF"+g(w(B))+"\u4E2A",1),u("p",null,g(T.value),1),u("p",null,g(A.value),1),a.value?(m(),N("p",_s,g("\u6587\u4EF6\u6253\u5305\u5931\u8D25\uFF0C\u8BF7\u4F7F\u7528chrome\u6D4F\u89C8\u5668\u8FDB\u884C\u6253\u5305"))):S("",!0),i(V,{data:p.value,style:{width:"100%"},"show-overflow-tooltip":"",size:"small"},{default:d(()=>[i(v,{type:"index",width:"50"}),i(v,{prop:"name",label:"\u6587\u4EF6\u540D",width:""}),i(v,{prop:"percentage",label:"\u4E0B\u8F7D\u8FDB\u5EA6"},{default:d(z=>[x(g(z.row.percentage)+g(z.row.type==="error"?"":"%"),1)]),_:1}),i(v,{prop:"size",label:"\u6587\u4EF6\u5927\u5C0F"},{default:d(z=>[x(g(w(le)(z.row.size)),1)]),_:1}),i(v,{prop:"status",label:"\u72B6\u6001"},{default:d(z=>[z.row.type==="loading"?(m(),E(D,{key:0,type:"primary",size:"small",link:""},{default:d(()=>[us]),_:1})):S("",!0),z.row.type==="success"?(m(),E(D,{key:1,type:"success",link:"",size:"small"},{default:d(()=>[fs]),_:1})):S("",!0),z.row.type==="error"?(m(),E(D,{key:2,type:"danger",link:"",size:"small"},{default:d(()=>[ps]),_:1})):S("",!0)]),_:1})]),_:1},8,["data"])])])}}},hs=Z(ms,[["__scopeId","data-v-140ab9d7"]]);const gs={class:"fileNameInput"},ws={class:"drag-item"},ys=x(" \u6DFB\u52A0 "),vs={__name:"FileNameInput",props:{modelValue:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(n,{emit:t}){const s=n,l=Ke(s,"modelValue",t),o=L(null),e=L({}),a=L(!1),r=({id:T})=>{const k=l.value.findIndex(A=>A.id===T);k>=0&&l.value.splice(k,1)},y=()=>{a.value=!0,we(()=>{var T,k;(T=o==null?void 0:o.value)==null||T.focus(),(k=o==null?void 0:o.value)==null||k.toggleMenu()})},p=()=>{if(console.log(R.exports.isEmpty(e.value)),!R.exports.isEmpty(e.value)){if(typeof e.value=="object"){let T=C.FIELD;["HEADER_NAME","FILE_NAME"].includes(e.value.type)&&(T=C[e.value.type]),l.value.push({id:e.value.id,name:e.value.name,type:T})}else l.value.push({id:e.value,name:e.value,type:C.CUSTOM_TEXT});e.value=null,a.value=!1}};return(T,k)=>{const A=te,B=Fe,c=ie,_=Ie,b=re,$=q;return m(),N("div",gs,[w(l).length>0?(m(),E(w(Re),{key:0,list:w(l),animation:"300",class:"drag-list",itemKey:"id"},{item:d(({element:h})=>[u("div",ws,[i(B,{closable:"","disable-transitions":!1,onClose:M=>r(h),type:w(it)[h.type]||"primary"},{default:d(()=>[i(A,null,{default:d(()=>[i(w(Se))]),_:1}),x(" "+g(h.name),1)]),_:2},1032,["onClose","type"])])]),_:1},8,["list"])):S("",!0),a.value?(m(),E(b,{key:1,modelValue:e.value,"onUpdate:modelValue":k[0]||(k[0]=h=>e.value=h),filterable:"",ref_key:"InputRef",ref:o,"allow-create":"",onChange:p,"value-key":"id",placeholder:"\u53EF\u8F93\u5165\u81EA\u5B9A\u4E49\u6587\u5B57",onKeyup:ge(p,["enter"])},{default:d(()=>[i(_,{label:"\u5B57\u6BB5"},{default:d(()=>[(m(!0),N(O,null,K(s.options,h=>(m(),E(c,{key:h.value,label:h.name,value:h},null,8,["label","value"]))),128))]),_:1}),i(_,{label:"\u5176\u4ED6"},{default:d(()=>[i(c,{label:"\u9644\u4EF6\u5BF9\u5E94\u8868\u5934",value:{name:"\u9644\u4EF6\u5BF9\u5E94\u8868\u5934",id:"HEADER_NAME",type:"HEADER_NAME"}}),i(c,{label:"\u9644\u4EF6\u539F\u59CB\u540D\u79F0",value:{name:"\u9644\u4EF6\u539F\u59CB\u540D\u79F0",id:"FILE_NAME",type:"FILE_NAME"}})]),_:1})]),_:1},8,["modelValue","onKeyup"])):(m(),E($,{key:2,class:"button-new-tag",onClick:y,icon:w(xe),size:"small"},{default:d(()=>[ys]),_:1},8,["icon"]))])}}},W=Z(vs,[["__scopeId","data-v-c36824e7"]]),bs=["Formula","AutoNumber","Barcode","CreatedTime","SingleSelect","CreatedUser","DateTime","Location","ModifiedTime","ModifiedUser","Number","Phone","Text","Url","User"],$s=bs.map(n=>j[n]);async function Fs(n){const t=[];return await Promise.all(n.map(async s=>{const l=s.id,o=s.name,e=await P.base.getTableById(l),a=await e.getFieldMetaList(),r=await e.getViewMetaList();t.push({tableId:l,tableName:o,fieldMetaList:a,viewMetaList:r})})),t}function Is(n,t){const s=new Map(t.map((l,o)=>[l.id,o]));return n.sort((l,o)=>{const e=s.has(l.id)?s.get(l.id):1/0,a=s.has(o.id)?s.get(o.id):1/0;return e-a})}const Ls={class:"form-container"},Es={style:{display:"flex","align-items":"center"}},Ts={style:{"margin-right":"2px"}},ks={style:{display:"flex"}},zs={style:{display:"flex","align-items":"center"}},Ns={style:{"margin-right":"2px"}},Ms={class:"btns"},Ss={class:"dialog-footer"},xs={__name:"Form",emits:["finshDownload"],setup(n,{emit:t}){const s=L(null),l=L(!0),o=L(!1),e=X({fileNamekList:[{name:"\u9644\u4EF6\u539F\u59CB\u540D\u79F0",id:"FILE_NAME",type:"FILE_NAME"}],tableId:"",attachmentFileds:[],viewId:"",downloadType:1,downloadTypeByFolders:!1,firstFolderKeys:[],secondFolderKeys:[]}),a=X({fileNamekList:[{required:!0,message:"\u8BF7\u9009\u62E9\u6587\u4EF6\u540D",trigger:"change"}],tableId:[{required:!0,message:"\u8BF7\u9009\u62E9\u6570\u636E\u8868",trigger:"change"}],attachmentFileds:[{required:!0,message:"\u8BF7\u9009\u62E9\u9644\u4EF6\u5B57\u6BB5",trigger:"change"}],viewId:[{required:!0,message:"\u8BF7\u9009\u62E9\u89C6\u56FE",trigger:"change"}],downloadType:[{required:!0,message:"\u8BF7\u9009\u62E9\u6587\u4EF6\u4E0B\u8F7D\u65B9\u5F0F",trigger:"change"}],secondFolderKeys:[{validator:(c,_,b)=>{if(R.exports.isEmpty(_)){b();return}if(R.exports.isEmpty(e.firstFolderKeys)){b(new Error("\u8BF7\u5148\u9009\u62E9\u4E00\u7EA7\u76EE\u5F55"));return}b()},trigger:"change"}]}),r=X({allInfo:[],finshDownload:!1}),y=U(()=>r.allInfo.find(_=>_.tableId===e.tableId)||null),p=U(()=>y.value?y.value.viewMetaList:[]),T=()=>{window.location.reload()},k=U(()=>y.value?y.value.fieldMetaList.filter(c=>{if(c.type===j.Attachment)return!0;if(c.type===j.Lookup){const{property:{refFieldId:_,refTableId:b}}=c,$=r.allInfo.find(M=>M.tableId===b),h=$==null?void 0:$.fieldMetaList.find(M=>M.id===_);if(console.log(123,h),(h==null?void 0:h.type)===j.Attachment)return!0}return!1}):[]);ee(()=>e.viewId,async c=>{if(c&&y.value){const $=await(await(await P.base.getTableById(e.tableId)).getViewById(e.viewId)).getFieldMetaList(),h=r.allInfo.find(M=>M.tableId===e.tableId);h.fieldMetaList=Is(h.fieldMetaList,$)}});const A=U(()=>y.value?y.value.fieldMetaList.filter(c=>$s.includes(c.type)):[]);ee(()=>e.tableId,()=>{p.value.find(_=>_.id===e.viewId)||(e.viewId=p.value.length?p.value[0].id:""),e.attachmentFileds=k.value.map(_=>_.id),e.firstFolderKeys=[],e.secondFolderKeys=[]});const B=async()=>{if(!await ze.getPermission({entity:Ne.Base,type:Me.Printable})){await P.ui.showToast({toastType:"warning",message:"\u60A8\u65E0\u6743\u9650\u4E0B\u8F7D\u9644\u4EF6\uFF0C\u8BF7\u8054\u7CFB\u7BA1\u7406\u5458"});return}!s.value||s.value.validate(_=>{_&&(r.finshDownload=!1,o.value=!0)})};return H(async()=>{let c=await P.base.getTableMetaList();c=c.filter($=>!!$.name),console.log("tableMetaList",c),r.allInfo=await Fs(c),console.log("allInfo",r.allInfo);const{tableId:_,viewId:b}=await P.base.getSelection();e.tableId=_,e.viewId=b,e.attachmentFileds=k.value.map($=>$.id),l.value=!1}),(c,_)=>{const b=ie,$=re,h=Le,M=te,I=de,F=Ee,v=q,D=Te,V=ke,z=ce;return ae((m(),N("div",Ls,[l.value?S("",!0):(m(),E(D,{key:0,ref_key:"elform",ref:s,class:"form",model:e,rules:a,"label-width":"auto","scroll-into-view-options":!0,"label-position":"left"},{default:d(()=>[i(h,{label:c.$t("data_table_column"),prop:"tableId"},{default:d(()=>[i($,{modelValue:e.tableId,"onUpdate:modelValue":_[0]||(_[0]=f=>e.tableId=f),placeholder:c.$t("select_data_table"),style:{width:"100%"}},{default:d(()=>[(m(!0),N(O,null,K(r.allInfo,f=>(m(),E(b,{key:f.tableId,label:f.tableName,value:f.tableId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),i(h,{label:c.$t("view_column"),prop:"viewId"},{label:d(()=>[u("p",Es,[u("span",Ts,g(c.$t("view_column")),1),i(I,{placement:"top-start",trigger:"hover",content:"\u53EF\u7B5B\u9009\uFF0C\u4E0B\u8F7D\u89C6\u56FE\u7B5B\u9009\u4E4B\u540E\u7684\u6570\u636E"},{reference:d(()=>[i(M,null,{default:d(()=>[i(w(se))]),_:1})]),_:1})])]),default:d(()=>[i($,{modelValue:e.viewId,"onUpdate:modelValue":_[1]||(_[1]=f=>e.viewId=f),placeholder:c.$t("select_view"),style:{width:"100%"}},{default:d(()=>[(m(!0),N(O,null,K(w(p),f=>(m(),E(b,{key:f.id,label:f.name,value:f.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),i(h,{label:c.$t("attachment_fields"),prop:"attachmentFileds"},{default:d(()=>[i($,{modelValue:e.attachmentFileds,"onUpdate:modelValue":_[2]||(_[2]=f=>e.attachmentFileds=f),multiple:"",placeholder:c.$t("select_attachment_fields"),style:{width:"100%"}},{default:d(()=>[(m(!0),N(O,null,K(w(k),f=>(m(),E(b,{key:f.id,label:f.name,value:f.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),i(h,{label:"\u6587\u4EF6\u547D\u540D\u89C4\u5219",prop:"fileNamekList"},{default:d(()=>[i(W,{options:w(A),modelValue:e.fileNamekList,"onUpdate:modelValue":_[3]||(_[3]=f=>e.fileNamekList=f),style:{width:"100%"}},null,8,["options","modelValue"])]),_:1}),i(h,{label:c.$t("download_method"),prop:"downloadType"},{default:d(()=>[i($,{modelValue:e.downloadType,"onUpdate:modelValue":_[4]||(_[4]=f=>e.downloadType=f),placeholder:c.$t("select_download_method"),style:{width:"100%"}},{default:d(()=>[i(b,{label:c.$t("download_individual_files"),value:2},null,8,["label"]),i(b,{label:c.$t("zip_download"),value:1},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),u("div",ks,[e.downloadType===1?(m(),E(h,{key:0,prop:"downloadTypeByFolders"},{label:d(()=>[u("p",zs,[u("span",Ns,g(c.$t("folder_classification")),1),i(I,{placement:"top-start",trigger:"hover",content:c.$t("folder_classification_hint")},{reference:d(()=>[i(M,null,{default:d(()=>[i(w(se))]),_:1})]),_:1},8,["content"])])]),default:d(()=>[i(F,{modelValue:e.downloadTypeByFolders,"onUpdate:modelValue":_[5]||(_[5]=f=>e.downloadTypeByFolders=f),"active-text":c.$t("yes"),"inactive-text":c.$t("no")},null,8,["modelValue","active-text","inactive-text"])]),_:1})):S("",!0)]),e.downloadType===1&&e.downloadTypeByFolders?(m(),E(h,{key:0,label:c.$t("first_directory"),prop:"firstFolderKey"},{default:d(()=>[i(W,{options:w(A),modelValue:e.firstFolderKeys,"onUpdate:modelValue":_[6]||(_[6]=f=>e.firstFolderKeys=f),style:{width:"100%"}},null,8,["options","modelValue"])]),_:1},8,["label"])):S("",!0),e.downloadType===1&&e.downloadTypeByFolders?(m(),E(h,{key:1,label:c.$t("second_directory"),prop:"secondFolderKeys"},{default:d(()=>[i(W,{options:w(A),modelValue:e.secondFolderKeys,"onUpdate:modelValue":_[7]||(_[7]=f=>e.secondFolderKeys=f),style:{width:"100%"}},null,8,["options","modelValue"])]),_:1},8,["label"])):S("",!0),u("div",Ms,[i(v,{type:"primary",onClick:B},{default:d(()=>[x(g(c.$t("download"))+" ",1),i(M,null,{default:d(()=>[i(w(De))]),_:1})]),_:1})])]),_:1},8,["model","rules"])),i(V,{modelValue:o.value,"onUpdate:modelValue":_[10]||(_[10]=f=>o.value=f),title:c.$t("file_download"),width:"80%","close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0},ye({default:d(()=>[o.value?(m(),E(hs,{key:0,formData:e,onFinsh:_[8]||(_[8]=f=>r.finshDownload=!0),zipName:w(y).tableName,attachmentList:w(k)},null,8,["formData","zipName","attachmentList"])):S("",!0)]),_:2},[r.finshDownload?{name:"footer",fn:d(()=>[u("span",Ss,[i(v,{onClick:_[9]||(_[9]=f=>T())},{default:d(()=>[x(g(c.$t("complete")),1)]),_:1})])])}:void 0]),1032,["modelValue","title"])])),[[z,l.value]])}}},Ds=()=>{const n=L(""),t=()=>{const s=document.documentElement,o={LIGHT:{"--el-color-primary":"rgb(20, 86, 240)","--el-bg-color":"#fff","--el-border-color-lighter":"#dee0e3"},DARK:{"color-scheme":"dark","--el-color-primary":"#4571e1","--el-bg-color":"#252525","--el-border-color-lighter":"#434343"}}[n.value];n.value==="DARK"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),Object.entries(o).forEach(([e,a])=>{s.style.setProperty(e,a)})};return H(async()=>{n.value=await P.bridge.getTheme(),t()}),P.bridge.onThemeChange(s=>{n.value=s.data.theme,t()}),{theme:n}};const As={class:"help"},Cs={target:"_blank",href:"https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=68dqfd50-145d-4cb0-ac18-53af1f73cad8"},Vs=x("\u5E2E\u52A9 "),Ps={class:"hd"},Us={class:"forms"},Bs={__name:"App",setup(n){Ds();const t=L(!0),s=()=>{t.value=!1,setTimeout(()=>{t.value=!0},300)};return(l,o)=>{const e=te,a=q,r=de,y=ce;return m(),N("main",null,[u("div",As,[u("a",Cs,[Vs,i(e,{class:"el-icon--right"},{default:d(()=>[i(w(Ae),{size:"small"})]),_:1})])]),u("div",Ps,[i(r,{placement:"top-start",width:"80%",trigger:"click"},{reference:d(()=>[i(a,{type:"primary"},{default:d(()=>[x(g(l.$t("usage_instructions")),1),i(e,{class:"el-icon--right"},{default:d(()=>[i(w(Ce))]),_:1})]),_:1})]),default:d(()=>[u("ol",null,[u("li",null,g(l.$t("notice_1")),1),u("li",null,g(l.$t("notice_2")),1),u("li",null,g(l.$t("notice_3")),1),u("li",null,g(l.$t("notice_4")),1),u("li",null,g(l.$t("notice_5")),1),u("li",null,g(l.$t("notice_6")),1),u("li",null,g(l.$t("notice_7")),1)])]),_:1}),i(a,{type:"primary",onClick:s},{default:d(()=>[x(g(l.$t("refresh_form")),1),i(e,{class:"el-icon--right"},{default:d(()=>[i(w(Ve))]),_:1})]),_:1})]),ae((m(),N("div",Us,[t.value?(m(),E(xs,{key:0,onFinshDownload:s})):S("",!0)])),[[y,!t.value]])])}}},Os=Z(Bs,[["__scopeId","data-v-e42a069f"]]);ve(Os).use(G).mount("#app");
